{% extends "base.html" %}

{% block title %}Admin Dashboard{% endblock %}

{% block content %}
    <!-- Page Header Start -->
    <div class="container-fluid page-header mb-5">
        <div class="container">
            <h1 class="display-4 pb-3 mb-0 animated slideInDown">Admin Dashboard</h1>
        </div>
    </div>
    <!-- Page Header End -->


    <!-- Admin Dashboard Content Start -->
    <div class="container-xxl py-5">
        <div class="container">
            <div class="row g-4 mb-5">
                <div class="col-12 text-center wow fadeInUp" data-wow-delay="0.1s">
                    <p class="d-inline-block border rounded text-primary fw-semi-bold py-1 px-3">Overview</p>
                    <h1 class="display-5 mb-5">Welcome to the Admin Dashboard</h1>
                </div>

                <!-- Key Metrics -->
                <div class="col-lg-12">
                    <h3 class="mb-4 wow fadeInUp" data-wow-delay="0.2s">Key Metrics</h3>
                    <div class="row g-4">
                        <div class="col-md-4 wow fadeInUp" data-wow-delay="0.3s">
                            <div class="card bg-primary text-white text-center p-4">
                                <i class="fa fa-users fa-3x mb-3"></i>
                                <h4 class="mb-2">Total Users</h4>
                                <h1 class="display-5 text-white" id="totalUsers">0</h1>
                            </div>
                        </div>
                        <div class="col-md-4 wow fadeInUp" data-wow-delay="0.4s">
                            <div class="card bg-success text-white text-center p-4">
                                <i class="fa fa-exchange-alt fa-3x mb-3"></i>
                                <h4 class="mb-2">Total Transactions</h4>
                                <h1 class="display-5 text-white" id="totalTransactions">0</h1>
                            </div>
                        </div>
                        <div class="col-md-4 wow fadeInUp" data-wow-delay="0.5s">
                            <div class="card bg-info text-white text-center p-4">
                                <i class="fa fa-dollar-sign fa-3x mb-3"></i>
                                <h4 class="mb-2">Total Revenue</h4>
                                <h1 class="display-5 text-white" id="totalRevenue">$0</h1>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Users -->
                <div class="col-lg-12 mt-5">
                    <h3 class="mb-4 wow fadeInUp" data-wow-delay="0.6s">Recent Users</h3>
                    <div class="table-responsive wow fadeInUp" data-wow-delay="0.7s">
                        <table class="table table-striped table-bordered">
                            <thead>
                                <tr>
                                    <th scope="col">#</th>
                                    <th scope="col">Name</th>
                                    <th scope="col">Email</th>
                                    <th scope="col">Registered Date</th>
                                    <th scope="col">Status</th>
                                </tr>
                            </thead>
                            <tbody id="recentUsersTableBody">
                                <!-- Dynamic content will be loaded here -->
                                <tr><td colspan="5" class="text-center">Loading recent users...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Recent Transactions -->
                <div class="col-lg-12 mt-5">
                    <h3 class="mb-4 wow fadeInUp" data-wow-delay="0.8s">Recent Transactions</h3>
                    <div class="table-responsive wow fadeInUp" data-wow-delay="0.9s">
                        <table class="table table-striped table-bordered">
                            <thead>
                                <tr>
                                    <th scope="col">#</th>
                                    <th scope="col">User</th>
                                    <th scope="col">Type</th>
                                    <th scope="col">Amount</th>
                                    <th scope="col">Date</th>
                                    <th scope="col">Status</th>
                                </tr>
                            </thead>
                            <tbody id="recentTransactionsTableBody">
                                <!-- Dynamic content will be loaded here -->
                                <tr><td colspan="6" class="text-center">Loading recent transactions...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </div>
    <!-- Admin Dashboard Content End -->

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const API_ENDPOINTS = {
            metrics: '/api/admin/metrics',
            recentUsers: '/api/admin/recent-users',
            recentTransactions: '/api/admin/recent-transactions'
        };

        async function fetchDashboardData() {
            try {
                const results = await Promise.allSettled([
                    fetch(API_ENDPOINTS.metrics, { credentials: 'include' }),
                    fetch(API_ENDPOINTS.recentUsers, { credentials: 'include' }),
                    fetch(API_ENDPOINTS.recentTransactions, { credentials: 'include' })
                ]);

                const metricsResult = results[0];
                const usersResult = results[1];
                const transactionsResult = results[2];

                let metrics = { total_users: 0, total_transactions: 0, total_volume: 0 };
                if (metricsResult.status === 'fulfilled' && metricsResult.value.ok) {
                    metrics = await metricsResult.value.json();
                } else {
                    console.error('Failed to fetch metrics:', metricsResult.reason || (metricsResult.value && metricsResult.value.statusText));
                    metrics = { total_users: 'N/A', total_transactions: 'N/A', total_volume: 'N/A' };
                }

                let recentUsers = [];
                if (usersResult.status === 'fulfilled' && usersResult.value.ok) {
                    recentUsers = await usersResult.value.json();
                    recentUsers = Array.isArray(recentUsers) ? recentUsers : [];
                } else {
                    console.error('Failed to fetch recent users:', usersResult.reason || (usersResult.value && usersResult.value.statusText));
                }

                let recentTransactions = [];
                if (transactionsResult.status === 'fulfilled' && transactionsResult.value.ok) {
                    recentTransactions = await transactionsResult.value.json();
                    recentTransactions = Array.isArray(recentTransactions) ? recentTransactions : [];
                } else {
                    console.error('Failed to fetch recent transactions:', transactionsResult.reason || (transactionsResult.value && transactionsResult.value.statusText));
                }

                return { metrics, recentUsers, recentTransactions };

            } catch (error) {
                console.error('Error fetching dashboard data:', error);
                return {
                    metrics: { total_users: 'N/A', total_transactions: 'N/A', total_volume: 'N/A' },
                    recentUsers: [],
                    recentTransactions: []
                };
            }
        }

        function updateKeyMetrics(metrics) {
            document.getElementById('totalUsers').textContent = metrics.total_users || 0;
            document.getElementById('totalTransactions').textContent = metrics.total_transactions || 0;
            const volume = typeof metrics.total_volume === 'number' ? metrics.total_volume.toLocaleString() : metrics.total_volume;
            document.getElementById('totalRevenue').textContent = `$${volume}`;
        }

        function updateRecentUsers(users) {
            const tableBody = document.getElementById('recentUsersTableBody');
            tableBody.innerHTML = '';
            if (!Array.isArray(users) || users.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center">No recent users found.</td></tr>';
                return;
            }
            users.forEach((user) => {
                const id = user.id ?? user.user_id ?? '';
                const name = user.full_name ?? user.name ?? '';
                const email = user.email ?? '';
                const created = user.created_at ? new Date(user.created_at).toLocaleString() : (user.registered_date || '');
                const status = (user.is_active === false) ? 'Inactive' : (user.is_active === true ? 'Active' : (user.status || ''));
                const row = `
                    <tr>
                        <th scope="row">${id}</th>
                        <td>${name}</td>
                        <td>${email}</td>
                        <td>${created}</td>
                        <td>${status}</td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }

        function updateRecentTransactions(transactions) {
            const tableBody = document.getElementById('recentTransactionsTableBody');
            tableBody.innerHTML = '';
            if (!Array.isArray(transactions) || transactions.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center">No recent transactions found.</td></tr>';
                return;
            }
            transactions.forEach((transaction) => {
                const id = transaction.id ?? '';
                // transaction may include a nested user or user_id
                const userLabel = (transaction.user && (transaction.user.full_name || transaction.user.email)) ? (transaction.user.full_name || transaction.user.email) : (transaction.user_id || transaction.user || '');
                const type = transaction.transaction_type ?? transaction.type ?? transaction.transactionType ?? '';
                const amount = typeof transaction.amount === 'number' ? transaction.amount : parseFloat(transaction.amount || 0);
                const date = transaction.created_at ? new Date(transaction.created_at).toLocaleString() : (transaction.date || '');
                const status = transaction.status || '';
                const row = `
                    <tr>
                        <th scope="row">${id}</th>
                        <td>${userLabel}</td>
                        <td>${type}</td>
                        <td>$${amount.toFixed ? amount.toFixed(2) : amount}</td>
                        <td>${date}</td>
                        <td>${status}</td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }

        async function initDashboard() {
            const data = await fetchDashboardData();
            updateKeyMetrics(data.metrics);
            updateRecentUsers(data.recentUsers);
            updateRecentTransactions(data.recentTransactions);

            setInterval(async () => {
                const newData = await fetchDashboardData();
                updateKeyMetrics(newData.metrics);
                updateRecentUsers(newData.recentUsers);
                updateRecentTransactions(newData.recentTransactions);
            }, 30000);
        }

        initDashboard();
    });
</script>
{% endblock %}
